# react 原理解析2

# reconciliation 协调
1. 在某一时间节点调⽤ React 的 render() 方法，会创建 一棵由 React 元素组成的树。在下⼀次 state 或 props更更新时，相同的 render() ⽅法会返回一棵不同的树。React 需要基于这两棵树之间的差别来判断如何有效率 的更新 UI 以保证当前 UI 与最新的树保持同步。
1. 将一棵树转为另外一颗树的最小操作数的算法复杂度为O(n 3), 开销太过昂贵，Reac基于以下的两个假设条件提出一套O(n)的启发式算法：
   1. **两个不同的类型的元素会产生不同的树**
   1. **开发者可以通过key prop来暗示哪些子元素在不同的渲染下保持稳定**



# diff算法
## diff策略

1. 同层比较，web ui中的dom节点跨层级的移动操作很少，可以忽略不计
1. 拥有不同类型的两个组件将会产生不同的树形结构
1. 开发者可以通过key prop 来那是哪些子元素在不同的渲染下保持稳定
## diff过程
**vnode(现在的虚拟dom)和newVnode(新的虚拟dom)**
对比两个虚拟dom时会有三种操作：删除、替换和更新

- 删除
newVnode不存在的时候
- 替换
vnode和newVnode类型不同或者key不同时
- 更新
有相同类型的key但vnode和newVnode不同时



# fiber					
## 为什么需要fiber?

1. 大型项目，组件树会很大，这个时候递归遍历的成本很高，会造成主线程持续被占用。结果就是主线程上的布局、动画等周期性任务无法立即得到处理，造成视觉上的卡顿，影响用户体验。
1. 任务分解的意义（解决上面的问题）
1. 增量渲染（把渲染任务拆分为块，匀到多帧）										
1. 更新时能暂停，终止，复用渲染任务
1. 给不同类型的更新赋予优先级
1. 并发方面新的基础能力
1. 更流畅
## 什么是fiber?
fiber是指组件上将要完成或者已经完成的任务，每个组件可以是一个或多个
## 实现fiber
**window.requestIdleCallBack(callback[, options])**
**window.requestIdleCallBack()方法将在浏览器的空闲时间段内调用的函数排队。使开发者能够在主事件循环上执行后台和低优先级的工作，而不会影响延迟关键事件。如动画和输入响应**

- callback
一个在事件循环空闲时即将被调用的函数的引用。函数会接受到一个名为 **IdleDeadLine** 的参数，这个参数可以获取当前空闲时间以及回调是否在超时时间前已经执行的状态。
## 关于Fiber
Fiber是React16中新的协调引擎。主要目的是使vdom可以进行增量式渲染。一个更新过程可能被打断。所以react Fiber一个更新过程分为两个阶段：第一个阶段是**Reconciliation**，第二个阶段是commit.

# HOOKS
为了拥抱函数式，让函数组件有了状态，可以替代class
